from flask import Blueprint, request
from application.base import BaseManager, render_jinja
import json
from application.db import  models
from application.utils import exception
from application.utils.query import Pager, success2json,exception2json,\
    grid_json,data2json,update_values
render = render_jinja('static/templates/base', encoding='utf-8',)

class StudentList(BaseManager):
    def __init__(self):
        pass
    def get(self):
        return render.base_lists()

class GridStudnet(BaseManager):
    def get(self):
        params = request.args
        # print "##############",params.get('page')
        filters = {}
        panger = Pager()
        page, total_paper, records, rows = panger.grid_rows_query(params=params, table='student', mode='count')
        cells = ['id', 's_name', 's_number', 's_sex', 'class_id', 's_e_mail',
                 's_telphone', 's_political', 'admission_time']
        rows_json = grid_json(page, total_paper, records, rows, 'id', cells)
        return rows_json




class BaseCreate(BaseManager):
    def get(self):
        params = request.args
        return render.student_create()
    def post(self):
        params = request.form
        values = {
            "s_name": params.get('c_name'),
            "s_e_mail": params.get('c_score'),
            "s_number": params.get('c_number'),
            "class_id": params.get('class_id'),
            "s_sex": params.get('s_sex'),
            "s_job":params.get('s_job'),
            "s_political":params.get('s_political'),
            "s_telphone":params.get('s_telphone'),
            "admission_time":params.get('admission_time'),
        }

        check_exist = models.Student.query.filter_by(s_number=params.get('s_number')).first()
        if check_exist is not None:
            return exception2json("student exist")
        student = models.Student(values).save()
        return success2json(student)
class StudentDelete(BaseManager):
    def get(self):
        # return render.student
        pass
class STudentUpdate(BaseManager):
    def get(self):
        params = request.args
        student = models.Student.query.filter_by(id=params.get('student_id')).first()
        return render.student_update(student=student)

    def post(self):
        params = request.form
        student = models.Student.query.filter_by(id=params.get('id')).first()
        if not student:
            return exception2json("student is not exist")
        values = {
            "s_name": params.get('c_name'),
            "s_e_mail": params.get('c_score'),
            "s_number": params.get('c_number'),
            "class_id": params.get('class_id'),
            "s_sex": params.get('s_sex'),
            "s_job": params.get('s_job'),
            "s_political": params.get('s_political'),
            "s_telphone": params.get('s_telphone'),
            "admission_time": params.get('admission_time'),
        }
        student.update(values)

        return success2json(student)
app = Blueprint('base_app', __name__, template_folder='templates')
app.add_url_rule('/lists', view_func=BaseList.as_view('base_lists'))
app.add_url_rule('/create', view_func=BaseCreate.as_view('base_create'))
app.add_url_rule('/update', view_func=BaseUpdate.as_view('base_update'))
app.add_url_rule('/delete', view_func=BaseDelete.as_view('base_delete'))

app.add_url_rule('/grid', view_func=GridBase.as_view('base_grid'))